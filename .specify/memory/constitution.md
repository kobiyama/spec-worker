<!--
  ============================================================================
  同期影響レポート
  ============================================================================
  バージョン変更: 2.1.1 → 2.2.0 (レビュー指摘対応)

  変更された原則:
  - V. グレースフル・デグラデーション
    - 「データ損失なく」→「追跡可能性を確保」に表現変更
    - インメモリ管理とMVP制約の整合性を明確化
    - 200 OK記載を削除（原則Iと重複のため）
  - III. エージェント通信プロトコル
    - 根拠文から時間表現を削除（原則Iに集約）

  追加セクション: なし

  削除セクション: なし

  テンプレート状況:
  - .specify/templates/plan-template.md: ✅ 互換性あり
  - .specify/templates/spec-template.md: ✅ 互換性あり
  - .specify/templates/tasks-template.md: ✅ 互換性あり

  フォローアップTODO: なし
  ============================================================================
-->

# Spec Worker 憲法

## 基本原則

### I. 非同期処理アーキテクチャ

GitHub Webhookの10秒タイムアウト制限とLLMの長時間処理（数分〜30分）を両立するため、
常駐サーバーによる非同期処理アーキテクチャを採用しなければならない（MUST）。

- Webhook受信後、10秒以内に200 OKを返却しなければならない（MUST）
- LLMエージェント処理は非同期で実行しなければならない（MUST）
- 複数リクエストの並列処理をサポートしなければならない（MUST）
- 各リクエストは独立した作業ディレクトリで処理しなければならない（MUST）

**根拠**: GitHubは10秒以内に応答がない場合、配信失敗として扱う。LLMの処理時間は数分〜30分かかるため、同期処理は不可能。サーバーレス関数のタイムアウト制限（Lambda 15分、Vercel 10分等）も超過するため、常駐サーバーが必須となる。

### II. Webhookセキュリティ

すべての受信webhookは処理前に暗号学的に検証しなければならない（MUST）。

- GitHub webhookの署名はHMAC-SHA256を使用して検証しなければならない（MUST）
- 無効な署名は処理なしで即座に401拒否しなければならない（MUST）
- Webhookシークレットは環境変数に保存しなければならない（MUST）、コード内への記載は禁止
- 悪用防止のためレート制限を実装しなければならない（MUST）

**根拠**: Webhookエンドポイントは公開アクセス可能であり、署名検証なしでは悪意のあるアクターが不正な操作をトリガーできてしまう。

### III. エージェント通信プロトコル

AIエージェント（Claude Code）との通信は定義されたコントラクトに従わなければならない（MUST）。

- Issueペイロードはエージェントへの送信前に標準化されたフォーマットに変換しなければならない（MUST）
- エージェントの応答はPR作成前に検証しなければならない（MUST）
- エージェント操作には設定可能なタイムアウトを実装しなければならない（MUST）
  - ループや異常状態の検知が目的であり、正常処理を制限するものではない
  - デフォルト値は環境変数`AGENT_TIMEOUT_MS`で設定可能（デフォルト: 30分）
- 失敗したエージェント操作はデバッグ用のコンテキストとともにログ出力しなければならない（MUST）
  - ただし機密データ（トークン、シークレット）はマスキングすること（MUST）
- 並列処理のため、各リクエストはGit Worktreeで独立した作業ディレクトリを使用しなければならない（MUST）

**根拠**: 信頼性の高いエージェント通信がこのサービスの核心的価値であり、障害は追跡可能かつ回復可能でなければならない。

### IV. 構造化ログとオブザーバビリティ

すべての操作はクエリ可能な構造化ログを出力しなければならない（MUST）。

- ログはJSON形式で一貫したフィールド名を使用しなければならない（MUST）
- すべてのリクエストはすべての操作に伝播される相関IDを持たなければならない（MUST）
- エラーログには以下を含めなければならない（MUST）：相関ID、エラータイプ、スタックトレース、入力コンテキスト
- 機密データ（トークン、シークレット）はログに出力してはならない（MUST NOT）
  - ログ出力前に機密データをマスキング/サニタイズする処理を実装すること（MUST）

**根拠**: 長時間実行されるプロセスのデバッグには優れたオブザーバビリティが必須である。

### V. グレースフル・デグラデーション

システムは障害時も可能な限り処理を継続し、追跡可能性を確保しなければならない（MUST）。

- 部分的な障害は後続のwebhook処理をブロックしてはならない（MUST NOT）
- 外部サービス呼び出し（GitHub API、エージェント）にはリトライ処理を実装すべきである（SHOULD）
- 処理中のジョブ状態はメモリ内で管理し、サーバー再起動時には未完了ジョブをログに記録すること（MUST）
  - ログには再処理に必要な情報（Issue番号、リポジトリ等）を含めること
- サーバー障害による未完了ジョブは、GitHub Issueを確認して手動で再トリガー可能とする

**根拠**: MVPではインメモリ管理を採用するため、サーバー再起動時のジョブ状態喪失は許容する。ただし追跡可能性を確保し、手動復旧を可能にする。将来的には永続ストレージの導入を検討する。

## システムアーキテクチャ

```
GitHub Webhook
      ↓
EC2 t3.micro/small（常駐Webサーバー）
  ├─ POST /webhook 受信
  │    ├─ 署名検証
  │    ├─ 即座に200 OK返却（10秒以内）
  │    └─ 非同期でジョブ開始
  │
  └─ 非同期ジョブ処理
       ├─ Git Worktree作成（リクエストごとに独立）
       ├─ Claude Code実行（完了まで待機、タイムアウトは異常検知用）
       ├─ PR作成
       └─ Worktree削除
```

**リポジトリ管理**:
- ベースリポジトリは1つのみクローン（`/repos/{owner}/{repo}`）
- 各リクエストはGit Worktreeで独立したディレクトリを作成
- 処理完了後、Worktreeは削除

```bash
# Worktree作成例
git worktree add ../worktrees/{job-id} -b feature/{issue-number}

# 処理完了後
git worktree remove ../worktrees/{job-id}
```

**コスト概算**（東京リージョン）:
- EC2 t3.micro: 約$8〜10/月（オンデマンド）、スポットなら$2〜3/月

## 技術スタック

本プロジェクトでは以下の技術選択が必須である：

- **ランタイム**: Node.js 20.x LTS
- **言語**: TypeScript（strictモード有効）
- **パッケージマネージャー**: npm または pnpm
- **Webフレームワーク**: Express または Fastify
- **HTTPクライアント**: ネイティブfetch API または axios（GitHub API呼び出し用）
- **テスト**: Vitest または Jest（ビジネスロジックで最低80%カバレッジ）
- **リンティング**: TypeScriptルール付きESLint
- **フォーマット**: 一貫した設定のPrettier

**制約**:
- MVPではデータベース不要（インメモリでジョブ管理）
- LLM処理時間が支配的なため、サーバーのパフォーマンス最適化は低優先度

## エージェント設定

本プロジェクトではClaude Code（Anthropic）を主エージェントとして使用する。
将来的にOpenAI Codex CLIを代替または併用する可能性がある。

### Claude Code（主エージェント）

**使用エージェント**: Claude Code CLI（Anthropic）

**呼び出し方法**:
```bash
claude --dangerously-skip-permissions -p "タスクの説明"
```

**オプション**:
- `--dangerously-skip-permissions`: 自動モード - ファイル読み書き、コマンド実行を自動承認
- `-p`: 非対話モード（プロンプトを直接渡す）

**環境要件**:
- Claude Code CLIがグローバルインストールされていること（`npm install -g @anthropic-ai/claude-code`）
- `ANTHROPIC_API_KEY`環境変数が設定されていること
- 対象リポジトリのローカルクローンが存在すること

**エージェントへの入力フォーマット**:
```
GitHub Issue #{issue_number}: {issue_title}

{issue_body}

---
リポジトリ: {repository_full_name}
ブランチ: {target_branch}
タスク: このIssueの内容に基づいてコードを修正し、変更をコミットしてください。
```

**成功条件**:
- Claude Codeが正常終了（exit code 0）
- 対象ブランチに1つ以上のコミットが作成されている
- 生成されたコードにセキュリティ上の明らかな問題がないこと（手動またはlintで検証）

### Codex CLI（代替エージェント・将来検討）

**呼び出し方法**:
```bash
codex exec --full-auto "タスクの説明"
```

**環境要件**:
- Codex CLIがグローバルインストールされていること
- OpenAIアカウントでログイン済みであること（`codex login`）

## セキュリティ要件

本サービスにおいてセキュリティは交渉の余地がない：

- **シークレット管理**: すべてのシークレット（GitHubトークン、webhookシークレット）は環境変数経由で注入しなければならない（MUST）
- **入力検証**: すべてのwebhookペイロードは期待されるスキーマに対して検証しなければならない（MUST）
- **最小権限**: GitHubトークンは必要最小限のスコープ（repo、pull_request）を持たなければならない（MUST）
- **監査証跡**: すべてのPR作成操作はアクターとタイムスタンプとともにログ出力しなければならない（MUST）
- **認証情報のログ禁止**: トークンとシークレットはすべてのログ出力から除外しなければならない（MUST）
- **ログのサニタイズ**: エラーコンテキストをログ出力する際は、機密データをマスキングしなければならない（MUST）

**コンプライアンス**:
- すべての外部通信はHTTPSのみ
- 機密データは保存時に保持しない（ステートレス設計）

## ガバナンス

この憲法はSpec Workerプロジェクトの他のすべての開発プラクティスに優先する。

**改正プロセス**:
1. 提案された変更は根拠とともに文書化しなければならない（MUST）
2. 基本原則の変更には明示的な承認が必要
3. すべての改正はバージョンと最終改正日を更新しなければならない（MUST）

**バージョニングポリシー**:
- MAJOR: 基本原則の削除または根本的な変更
- MINOR: 新しい原則の追加または既存ガイダンスの大幅な拡張
- PATCH: 明確化、タイポ修正、非意味的な改良

**コンプライアンス検証**:
- すべてのPRは実装計画に憲法チェックを含めなければならない（MUST）
- コードレビューはセキュリティ要件への準拠を検証しなければならない（MUST）
- 違反は正当化とともに複雑性追跡に文書化しなければならない（MUST）

**バージョン**: 2.2.0 | **制定日**: 2025-01-22 | **最終改正日**: 2025-01-24
